app.controller("loginController",["$scope","$state","$rootScope","$document","$timeout","$interval","getDataSource","DateService","SessionService","smsService","CommonService","CookieService","Base64","$http",function(e,r,i,t,o,n,s,g,l,a,d,c,f,m){e.loginPanelStyle=[!0,!1,!1,!1,!1,!1,!1,!1],e.loginError={isnamenull:!1,ispwdnull:!1,isverifynull:!1,isverifyfailed:!1,isloginfailed:!1,islogining:!1,message:"",reset:function(){this.isloginfailed=!1,this.isverifyfailed=!1,this.ispwdnull=!1,this.isnamenull=!1,this.isverifynull=!1,this.message=""}},e.goBackIndex=function(){r.reload()},e.registerError={idx:0,message:"",style:[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],reset:function(){for(var e=0;e<this.style.length;e++)this.style[e]=!1}},e.registerObj={name:"",cellphone:"",verifycode:"",smscode:"",type:0,password1:"",password2:"",logname:"",category:"国家部委",reset:function(){this.name="",this.cellphone="",this.verifycode="",this.smscode="",this.type=0,this.password1="",this.password2="",this.logname="",this.category=""}},e.loginObj={logname:"",logpwd:"",secretpwd:"",verifycode:"",isremember:!1,reset:function(){this.logname="",this.logpwd="",this.secretpwd="",this.verifycode="",this.isremember=!1}},e.findpwdObj={cellphone:"",yzmcode:"",smsyzmcode:"",password1:"",password2:"",fromApp:!1,reset:function(){this.cellphone="",this.yzmcode="",this.smsyzmcode="",this.password1="",this.password2=""}},e.showErrorMessage=function(r,i,t){e.registerError.reset(),e.registerError.message=r,e.registerError.idx=i,e.registerError.style[i]=t};var u=c.get("loginObj");if(u){var p=JSON.parse(u);p&&(e.loginObj.isremember=!0,e.loginObj.logname=p.logname)}e.registerStep=[{title:"登录",result:!1,index:0,event:function(){e.changePanel(0)}},{title:"二维码",result:!1,index:1,event:function(){e.changePanel(1)}},{title:"注册",result:!1,index:2,event:function(){e.changePanel(2)}},{title:"填写验证信息",result:!1,index:3,event:function(){return e.registerObj.name==e.registerObj.colleague1?(e.registerError.message="同事(一)不能是自己",e.registerError.idx=2,void(e.registerError.style[e.registerError.idx]=!0)):e.registerObj.name==e.registerObj.colleague2?(e.registerError.message="同事(二)不能是自己",e.registerError.idx=3,void(e.registerError.style[e.registerError.idx]=!0)):e.registerObj.colleague1==e.registerObj.colleague2?(e.registerError.message="同事(一)和同事(二)不能一致",e.registerError.idx=3,void(e.registerError.style[e.registerError.idx]=!0)):(e.registerObj.type=0,void e.validateInfo(function(r){r.model&&(e.registerObj.cellphone=r.model.cellphone,e.registerObj.logname=r.model.logname),e.changePanel(3)}))}},{title:"填写注册信息",result:!1,index:4,event:function(){e.registerObj.type=1,e.validateInfo(function(r){e.changePanel(7),e.loginObj.reset(),e.findpwdObj.reset(),e.timerInterval.reset()})}},{title:"设置密码",result:!1,index:7,event:function(){return 0==e.registerObj.password1.length?(e.registerError.message="密码不能为空",e.registerError.idx=0,void(e.registerError.style[e.registerError.idx]=!0)):0==e.registerObj.password2.length?(e.registerError.message="确认密码不能为空",e.registerError.idx=1,void(e.registerError.style[e.registerError.idx]=!0)):e.registerObj.password2!=e.registerObj.password2?(e.registerError.message="两次输入密码不一致",e.registerError.idx=1,void(e.registerError.style[e.registerError.idx]=!0)):(e.registerObj.type=2,e.registerObj.pass1=md5(e.registerObj.password1),e.registerObj.pass2=md5(e.registerObj.password2),void e.validateInfo(function(r){e.changePanel(4),e.registerObj.reset(),e.loginObj.reset(),e.findpwdObj.reset(),e.timerInterval.reset()}))}},{title:"完成注册",result:!1,index:5,event:function(){}},{title:"找回密码验证",result:!1,index:6,event:function(){e.existscellphone(function(){e.changePanel(6)})}},{title:"重置密码",result:!1,index:8,event:function(){e.resetpwd(function(){alert("密码已找回,请重新登录"),e.changePanel(0),e.registerObj.reset(),e.loginObj.reset(),e.findpwdObj.reset(),e.timerInterval.reset()})}}],e.changePanel=function(r){for(var i=0;i<e.loginPanelStyle.length;i++)e.loginPanelStyle[i]=!1;e.loginPanelStyle[r]=!0},e.userChanged=function(){e.isuserchange=!0},e.$watch("registerObj.provice",function(r){r&&e.allCity&&(e.currentCities=_.filter(e.allCity,{name:r})[0].city,e.currentCounties=[],e.isuserchange&&(e.registerObj.city=e.currentCities[0].name))}),e.$watch("registerObj.city",function(r){r&&e.currentCities&&(e.currentCounties=_.filter(e.currentCities,{name:r})[0].area,e.isuserchange&&(e.registerObj.area=e.currentCounties[0]))}),m.get("../config/usercenter-city.json").then(function(r){e.allCity=r.data}),e.nextStep=function(r,i){if(e.registerError.reset(),i)e.changePanel(r);else{var t=_.find(e.registerStep,{index:r});void 0!=t&&t.event()}},e.validateInfo=function(r){e.formData=angular.copy(e.registerObj),e.formData.password1=md5(e.formData.password1),e.formData.password2=md5(e.formData.password2),s.getUrlData("../api/registervalidate",e.formData,function(i){i.result?r(i):(e.registerError.message=i.message,e.registerError.idx=i.validateIndex,e.registerError.style[i.validateIndex]=!0)},function(e){})},e.remoteCheckCellphone=function(){s.getUrlData("../api/registerExistsCellphone",{cellphone:e.registerObj.cellphone},function(r){r.length>0?e.showErrorMessage("手机号码已被使用",0,!0):e.showErrorMessage("",0,!1)},function(e){})},e.cellphoneInvalidMsgClear=function(){e.showErrorMessage("",0,!1)},e.remoteCheckLogname=function(){s.getDataSource("selectSyAccountByLogname",{logname:e.registerObj.logname},function(r){r.length>0?e.showErrorMessage("登录名已被使用",2,!0):e.showErrorMessage("",2,!1)},function(e){})},e.lognameInvalidMsgClear=function(){e.showErrorMessage("",2,!1)},e.inputCheckPassword=function(r){e.registerObj.password1.length>0&&e.registerObj.password2.length>0&&e.registerObj.password1!=e.registerObj.password2?e.showErrorMessage("确认密码和密码输入不一致",r,!0):e.showErrorMessage("",r,!1)},e.passwordInvalidMsgClear=function(r){e.showErrorMessage("",r,!1)},e.existscellphone=function(r){s.getUrlData("../api/existscellphone",e.findpwdObj,function(i){i.result?r(i):(e.registerError.message=i.message,e.registerError.idx=i.validateIndex,e.registerError.style[i.validateIndex]=!0,e.changefindpwdVerifyCode())},function(e){})},e.resetpwd=function(r){if(0==e.findpwdObj.password1.length)return e.registerError.message="新密码不能为空",e.registerError.idx=4,void(e.registerError.style[e.registerError.idx]=!0);if(0==e.findpwdObj.password2.length)return e.registerError.message="确认密码不能为空",e.registerError.idx=5,void(e.registerError.style[e.registerError.idx]=!0);if(e.findpwdObj.password2!=e.findpwdObj.password1)return e.registerError.message="两次输入密码不一致",e.registerError.idx=5,void(e.registerError.style[e.registerError.idx]=!0);var i={cellphone:e.findpwdObj.cellphone,yzmcode:e.findpwdObj.yzmcode,smsyzmcode:e.findpwdObj.smsyzmcode,password1:md5(e.findpwdObj.password1),password2:md5(e.findpwdObj.password2)};s.getUrlData("../api/resetpassword",i,function(i){i.result?r(i):(e.registerError.message=i.message,e.registerError.idx=i.validateIndex,e.registerError.style[i.validateIndex]=!0)},function(e){})},e.verifySMSCode=function(e,r,i,t){s.getUrlData("../api/VerifySMSCode",{smscode:e,keyname:r},function(e){"success"==e.code?i():t()},function(e){})},e.verifyCodeClick=function(r,i,t,o){11==r.trim().length&&e.isVerifyCode&&(e.registerError.reset(),e.verifySMSCode(i,t,function(){e.isVerifyCode=!1,s.getUrlData("../api/getSMSCode",{phone:r,keyname:"validatesmscode"},function(e){"success"==e.code},function(e){}),e.timerInterval.interval()},function(){e.registerError.message="验证码不正确",e.registerError.idx=o,e.registerError.style[o]=!0}))},e.btnVerifyCode="获取验证码",e.isVerifyCode=!0,e.timerInterval={interval:function(){var r=90;e.timer=n(function(){r--,e.btnVerifyCode=r+"秒",e.isVerifyCode=!1,0==r&&(e.isVerifyCode=!0,e.btnVerifyCode="获取验证码",e.timerInterval.reset())},1e3)},reset:function(){e.btnVerifyCode="获取验证码",e.isVerifyCode=!0,n.cancel(e.timer)}},e.loginVerifyCodeSrc="../api/VerifyCode/loginverify/"+(new Date).getTime(),e.changeLoginVerifyCode=function(){e.loginVerifyCodeSrc="../api/VerifyCode/loginverify/"+(new Date).getTime()},e.regVerifyCodeSrc="../api/VerifyCode/regverify/"+(new Date).getTime(),e.changeRegVerifyCode=function(){e.regVerifyCodeSrc="../api/VerifyCode/regverify/"+(new Date).getTime()},e.findpwdVerifyCodeSrc="../api/VerifyCode/findpwdverify/"+(new Date).getTime(),e.changefindpwdVerifyCode=function(){e.findpwdVerifyCodeSrc="../api/VerifyCode/findpwdverify/"+(new Date).getTime()},e.SaveRegister=function(){e.validateInfo(function(r){r.result?(d.layAlert("注册成功"),e.goBackIndex()):d.layErrorAlert("注册失败")})},e.login=function(){if(e.loginError.reset(),""==e.loginObj.logname||0==e.loginObj.logname.trim().length)return void(e.loginError.isnamenull=!0);if(""==e.loginObj.logpwd||0==e.loginObj.logpwd.trim().length)return void(e.loginError.ispwdnull=!0);if(""==e.loginObj.verifycode||0==e.loginObj.verifycode.trim().length)return void(e.loginError.isverifynull=!0);e.beginLoading=!e.beginLoading,e.loginError.islogining=!0;var r={logname:e.loginObj.logname,hashpwd:md5(e.loginObj.logpwd),verifycode:e.loginObj.verifycode};s.getUrlData("../api/Login",r,function(r){if(r.result){if(e.loginObj.isremember){var t={logname:e.loginObj.logname,time:g.format(new Date,"yyyy-MM-dd hh:mm:ss")};c.save("loginObj",JSON.stringify(t))}else c.remove("loginObj");i.user=r.loginUser,location.href="../html/index.html"}else e.loginError.isverifyfailed=r.isVerify,e.loginError.isloginfailed=!r.result,e.loginError.islogining=!1,e.beginLoading=!1,e.changeLoginVerifyCode(),e.loginError.message=r.message},function(r){e.loginError.islogining=!1,e.beginLoading=!1})}}]),app.controller("mainController",["$scope","$rootScope",function(e,r){e.gologin=function(){location.href="../html/login.html"}}]);