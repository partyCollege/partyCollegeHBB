app.controller("mainController",["$scope","$rootScope","$state","$http","$location","$document","getDataSource","DateService","SessionService","FilesService",function(e,t,a,n,o,i,r,s,c,l){e.defaultUserPhoto="../img/default_img.png",e.userHeadphoto=l.getUserPhoto(),e.departmentname=t.user.departmentName,e.yearplanStudytimeRate=0,e.userReportData={id:"",userid:"",classcount:0,waitcoursecount:0,finishedcoursecount:0,totalstudytime:0,electivestudytime:0};var u={studentid:t.user.studentId,year:(new Date).getFullYear()};r.getDataSource("getUserReportByUserId",u,function(a){if(a&&a.length>0){e.userReportData=a[0],e.showYeaplan=!1;e.userReportData.totalstudytime;if(t.user.yearplan&&""!=t.user.yearplan.departmentname){e.departmentname=t.user.yearplan.departmentname;var n=t.user.yearplan.studytime;"无"!=n&&(e.showYeaplan=!0,e.yearplanStudytimeRate=e.userReportData.yearplan_progess)}}else e.userReportData.classcount=0,e.userReportData.finishedcoursecount=0,e.userReportData.totalstudytime=0;setTimeout(function(){var t=$("#indicatorContainer").data("radialIndicator");t.animate(e.yearplanStudytimeRate)},300)},function(e){}),t.confirmOptions={message:"提示",isOpened:!1,open:function(){this.isOpened=!0},closed:function(){this.isOpened=!1}},$(function(){$("#indicatorContainer").radialIndicator({barColor:"#1c5c97",barWidth:5,initValue:100,roundCorner:!0,percentage:!0,displayNumber:!1,radius:50})});for(var d=o.$$path,f=d.split("/"),p=(f[f.length-1],0);p<t.mainConfig.length;p++){var m=t.mainConfig[p];m.select=!1;for(var g=0;g<m.childMenus.length;g++)if(d.indexOf(m.childMenus[g])>=0){m.select=!0;break}}e.aClick=function(e){_.find(t.mainConfig,{select:!0}).select=!1,_.find(t.mainConfig,{elementName:e}).select=!0},t.loadingOptions={message:"正在处理中,请稍候",isOpened:!1}}]),app.controller("usercenterController",["$scope","$rootScope","$document",function(e,t,a){a[0].title="个人中心"}]),app.controller("userinfoController",["$scope","$rootScope","$document","$http","$timeout","$interval","getDataSource","DateService","FilesService","CommonService","smsService","UserPhotoService","Base64",function(e,t,a,n,o,i,r,s,c,l,u,d,f){e.showAvatar=!1,e.showZJPhoto=!1,e.showIDContainer=!1,e.uploadTitle="上传头像",a[0].title=_.find(t.userCenterLinks,{id:"3001"}).title,e.ischangepwd=!1,e.ischangetel=!1,e.isuserchange=!1,e.getSysCode=function(t){r.getUrlData("../api/getsycodes",{categorys:"职级,政治面貌,民族"},function(a){e.politicalArr=_.find(a,{type:"政治面貌"}).list,e.levelArr=_.find(a,{type:"职级"}).list,e.nations=_.find(a,{type:"民族"}).list,n.get("../config/usercenter-city.json").then(function(a){e.allCity=a.data,t&&t()})},function(e){})},e.getSysCode(function(){r.getDataSource("getUserInfo",{studentid:t.user.studentId},function(t){var a=t[0];a.telphone=_.fill(a.cellphone.split(""),"*",3,7).join(""),a.photo_servername?(a.photo=c.getUserPhoto(),a.photoObj=a.photo):a.defaultphoto="../img/default_img.png",e.userinfo=a,e.sourceUserInfo=angular.copy(a)})}),e.$watch("userinfo.provice",function(t){t&&e.allCity&&(e.currentCities=_.filter(e.allCity,{name:t})[0].city,e.currentCounties=[],e.isuserchange&&(e.userinfo.city=e.currentCities[0].name))}),e.$watch("userinfo.city",function(t){t&&e.currentCities&&(e.currentCounties=_.filter(e.currentCities,{name:t})[0].area,e.isuserchange&&(e.userinfo.area=e.currentCounties[0]))}),e.userInfoEdited=!0,e.workPlaceEdited=!0,e.editedClick=function(t){e.showIDContainer=!e.showIDContainer,1==t?(e.workPlaceEdited=!e.workPlaceEdited,e.workPlaceEdited&&(e.userinfo=angular.copy(e.sourceUserInfo),e.isuserchange=!1)):0==t&&(e.userInfoEdited=!e.userInfoEdited,e.userInfoEdited&&(e.userinfo=angular.copy(e.sourceUserInfo)))},e.userChanged=function(){e.isuserchange=!0},e.pwdObj={sourcepassword:"",password:"",confirmpassword:"",message:""},e.telObj={accountid:t.user.accountId,telphone:"",syscode:"",inputcode:"",message:""},e.btnVerifyCode="获取验证码",e.isVerifyCode=!0,e.isChangePwd=!1,e.isChangeTel=!1,e.pwdDialogClick=function(t){e.isChangePwd=t,t||(e.pwdObj={sourcepassword:"",password:"",confirmpassword:"",message:""})},e.telDialogClick=function(a){e.isChangeTel=a,a||(e.telObj={accountid:t.user.accountId,telphone:"",code:""},e.btnVerifyCode="获取验证码",e.isVerifyCode=!0,i.cancel(e.timer))},e.verifyCodeClick=function(){return e.updateCellPhoneErrorStyle.reset(),11!=e.telObj.telphone.trim().length?(e.updateCellPhoneErrorStyle.idx[0]=!0,void(e.updateCellPhoneErrorStyle.message="手机号码格式不正确")):void r.validateCode(e.telObj.verifycode,"forgotpwdcode",function(){e.isVerifyCode=!1,r.getUrlData("../api/getSMSCode",{phone:e.telObj.telphone,keyname:"forgotpwdsmscode"},function(e){"success"==e.code},function(e){});var t=90;e.timer=i(function(){t--,e.btnVerifyCode=t+"秒之后重新发送",e.isVerifyCode=!1,0==t&&(e.isVerifyCode=!0,e.btnVerifyCode="重新获取验证码",i.cancel(e.timer))},1e3)},function(){e.changeRegVerifyCode(),e.updateCellPhoneErrorStyle.idx[1]=!0,e.updateCellPhoneErrorStyle.message="验证码不正确"})},e.modifyPwdDisabled=!1,e.modifyPwd=function(){e.modifyPwdDisabled=!0;var a={accountid:t.user.accountId,sourcepassword:f.encode(e.pwdObj.sourcepassword),confirmpassword:f.encode(e.pwdObj.confirmpassword),password:f.encode(e.pwdObj.password)};r.getUrlData("../api/changepassword",a,function(t){e.modifyPwdDisabled=!1,l.alert(t),t.result&&(e.pwdDialogClick(!1),r.writeLog("操作-登录密码修改","20019"))},function(t){e.modifyPwdDisabled=!1,l.error(t)})},e.updateCellPhoneBtnDisabled=!1,e.updateCellPhoneErrorStyle={idx:[!1,!1,!1],message:"",reset:function(){this.idx=[!1,!1,!1]}},e.modifyTel=function(){return e.updateCellPhoneBtnDisabled=!0,e.updateCellPhoneErrorStyle.reset(),0==e.telObj.telphone.trim().length?(e.updateCellPhoneErrorStyle.idx[0]=!0,e.updateCellPhoneErrorStyle.message="手机号码不能为空",void(e.updateCellPhoneBtnDisabled=!1)):0==e.telObj.inputcode.trim().length?(e.updateCellPhoneErrorStyle.idx[2]=!0,e.updateCellPhoneErrorStyle.message="手机验证码不能为空",void(e.updateCellPhoneBtnDisabled=!1)):void r.validateCode(e.telObj.inputcode,"forgotpwdsmscode",function(){var a={accountid:t.user.accountId,studentid:t.user.studentId,cellphone1:e.telObj.telphone,cellphone2:e.telObj.telphone};r.getDataSource("getMYDES_ENCRYPT_More_Cellphone",a,function(t){a.cellphone1=t[0].cellphone1,a.cellphone2=t[0].cellphone2,r.getDataSource("usercenter-changetel",a,function(t){t.length>0&&t[0].crow>1?(e.userinfo.telphone=_.fill(e.telObj.telphone.split(""),"*",3,7).join(""),e.telDialogClick(!1),l.alert("手机号码修改成功"),e.updateCellPhoneBtnDisabled=!1,r.writeLog("操作-手机号码修改","20019")):(l.alert("手机号码修改失败"),e.updateCellPhoneBtnDisabled=!1)},function(t){l.error(t),e.updateCellPhoneBtnDisabled=!1})},function(e){})},function(){e.updateCellPhoneErrorStyle.idx[2]=!0,e.updateCellPhoneErrorStyle.message="手机验证码输入不正确",e.updateCellPhoneBtnDisabled=!1})},e.saveInfoDisabled=!1,e.submit=function(t){if(e.saveInfoDisabled=!0,e.userInfoEdited||0!=t){if(!e.workPlaceEdited&&1==t){var a={provice:e.userinfo.provice,city:e.userinfo.city,area:e.userinfo.area,company:e.userinfo.company,companyaddress:e.userinfo.companyaddress,officetel:e.userinfo.officetel,studentid:e.user.studentId};r.getDataSource("updateUserInfoCompanyInfo",a,function(t){e.sourceUserInfo=angular.copy(e.userinfo),e.workPlaceEdited=!0,l.alert("保存单位信息成功！"),e.saveInfoDisabled=!1,r.writeLog("操作-单位信息修改","20019")},function(t){l.alert("保存单位信息失败！"),e.saveInfoDisabled=!1})}}else{var a={sex:e.userinfo.sex,nation:e.userinfo.nation,political:e.userinfo.political,rank:e.userinfo.rank,positions:e.userinfo.positions,email:e.userinfo.email,studentid:e.user.studentId};r.getDataSource("updateUserInfoBaseInfo",a,function(t){e.saveInfoDisabled=!1,e.sourceUserInfo=angular.copy(e.userinfo),e.userInfoEdited=!0,l.alert("保存基本信息成功！"),r.writeLog("操作-基本信息修改","20019")},function(t){e.saveInfoDisabled=!1,l.alert("保存基本信息失败！")})}},e.showZJpopup=!1,e.showZJPhotoBox=function(t){e.showZJpopup=!e.showZJpopup,t?e.uploadTitle="上传证件照":e.uploadTitle="上传头像"},e.regVerifyCodeSrc="../api/VerifyCode/forgotpwdcode/"+(new Date).getTime(),e.changeRegVerifyCode=function(){e.regVerifyCodeSrc="../api/VerifyCode/forgotpwdcode/"+(new Date).getTime()},e.showAvatarUpload=function(){"none"==$("#showAvatarDiv").css("display")?$("#showAvatarDiv").css("display","block"):$("#showAvatarDiv").css("display","none")},o(function(){new fullAvatarEditor("../bower_components/fullAvatarEditor-2.3/fullAvatarEditor.swf","../bower_components/fullAvatarEditor-2.3/expressInstall.swf","swfContainer",{id:"swf",upload_url:"../api/uploadAvatar/userPhoto",method:"post",tab_visible:!1,src_upload:1,tab_active:"upload",avatar_sizes:"80*80",avatar_sizes_desc:"80*80像素",src_size:"1MB",src_size_over_limit:"文件大小超出限制（1MB）\n请重新上传",browse_tip:"仅支持JPG、JPEG、GIF、PNG格式的图片文件\n文件不能大于1MB"},function(a){if(5==a.code){e.showAvatar=!1,e.userinfo.photoObj=c.showFile("userPhoto",a.content.avatarUrls,a.content.avatarUrls);var n={studentid:t.user.studentId,idphoto:a.content.avatarUrls,thumbname:a.content.avatarUrls};r.getDataSource("updateUserInfoHeadImage",n,function(e){l.alert("修改图像成功！"),r.changeUserPhoto(a.content.avatarUrls,a.content.avatarUrls)},function(e){l.alert("修改图像失败！")}),r.writeLog("操作-头像修改","20019"),e.$apply(),$("#showAvatarDiv").css("display","none")}})},1e3),e.validation={confirmpassword:{message:"",valid:!1,comfirm:function(e,t){e!=t?(this.message="两次输入密码不一致",this.valid=!1):(this.message="",this.valid=!0)},reset:function(){this.message=""}},validtelphone:{message:"",valid:!1,remotetelphone:function(e,t){if(e==t)this.valid=!1,this.message="新手机号码不能和原手机号码一样";else{this.message="";var a=this;r.getDataSource("usercenter-telphone-valid",{cellphone:t},function(e){e.length>0&&e[0].count>0?(a.valid=!1,a.message="新手机号码已经存在"):(a.valid=!0,a.message="")},function(e){l.error(e)})}},reset:function(){this.message=""}}}}]),app.controller("archivesController",["$scope","$rootScope","$timeout","$state","$stateParams","getDataSource","CommonService",function(e,t,a,n,o,i,r){e.getArchives=function(){i.getDataSource("getarchives",{studentid:t.user.studentId},function(t){if(t&&t.length>0){for(var a=0;a<t.length;a++)t[a].expand=!1,t[a].src="../img/arrow01.png",t[a].keywordsArr=t[a].keywords.split(","),t[a].total_time_cn=(parseInt(t[a].total_time)/3600).toFixed(1);t[0].expand=!0,t[0].src="../img/arrow02.png",e.datalist=t}},function(e){})},e.onExpand=function(e){e.expand=!e.expand,e.src=0==e.expand?"../img/arrow01.png":"../img/arrow02.png"},e.goTrain=function(e){var t="indexfront.html#/main/studytotal/"+e;location.href=t},e.getArchives()}]),app.controller("containerController",["$scope","$rootScope","$http","$document","getDataSource",function(e,t,a,n,o){n[0].title=_.find(t.myStudyLinks,{id:"1002"}).title}]),app.controller("courseinfoController",["$scope","$stateParams","$rootScope","$interval","$timeout","$document","getDataSource","FilesService","CommonService",function(e,t,a,n,o,i,r,s,c){function l(e){return 1==e.isplaycompletion?(e.buttontext="已学",e.style=!1):1==e.iselectivechoose&&e.isrequiredchoose?(e.buttontext="已选",e.style=!1):1==e.iselectivechoose?(e.buttontext="选修已选",e.style=!1):1==e.isrequiredchoose?(e.buttontext="必修已选",e.style=!1):(e.buttontext="选课",e.style=!0),e}function u(e){for(var t=0;t<e.length;t++)e[t].userphoto=s.showFile("userPhoto",e[0].photo_serverthumbname,e[0].photo_serverthumbname);return e}e.searchparameter={coursewareid:t.id,studentid:a.user.studentId,studentid2:a.user.studentId,pageIndex:1,pageSize:5,isMore:!1},e.datateacher=[],e.getCourseInfo=function(){r.getDataSource(["getCourseInfo_SelectCourse","getCoursewareTeachers"],e.searchparameter,function(t){var a=_.find(t,{name:"getCourseInfo_SelectCourse"}).data;e.datateacher=_.find(t,{name:"getCoursewareTeachers"}).data,a[0].photo=s.showFile("coursewarePhoto",a[0].imagephoto,a[0].imagephoto),e.courseinfo=l(a[0]),e.courseinfo.comment=null==e.courseinfo.comment||void 0==e.courseinfo.comment||""==e.courseinfo.comment?"暂无简介":e.courseinfo.comment,e.courseinfo.iselective=null==e.courseinfo.relationid?0:1,i[0].title=e.courseinfo.coursewarename,e.courseinfo.isrequiredchoose>0&&e.getRequiredClass()},function(e){})},e.getRequiredClass=function(){r.getDataSource("getRequiredClassList_CourseInfo",e.searchparameter,function(t){e.myClasslist=t},function(e){})},e.goClass=function(e){a.user&&1==a.user.isLogin?(a.user.classId=e,r.getUrlData("../api/ChangeClass",{classid:e},function(e){(e.result=!0)&&(location.href="../html/indexfront.html#/main/myclass")},function(e){})):alert("登录时效已过期,请重新登录")},e.chooseCourse=function(){if(!(e.courseinfo.iselectivechoose>0||e.courseinfo.isrequiredchoose>0)){e.searchparameter.status="0";var t=function(){r.getUrlData("../api/addcoursewareuser",e.searchparameter,function(t){t.result&&(e.courseinfo.iselectivechoose=1,e.courseinfo.style=!1,e.courseinfo.buttontext="选修已选",e.courseinfo.jointime=t.data,c.alert("选修课程成功"))},function(e){})};_.merge(a.confirmOptions,{message:"确定选修该课程吗?",confirm:function(){t()}}),a.confirmOptions.open()}},e.playVideo=function(){if(e.courseinfo.iselectivechoose>0||e.courseinfo.isrequiredchoose>0){var t="../html/indexvideo.html#/beforevideo/"+e.searchparameter.coursewareid;window.open(t,"playVideo")}},e.search=function(){e.searchparameter.isMore=!1,r.getUrlData("../api/getallcoursecomments",e.searchparameter,function(t){t.result&&(e.datalist=_.union(e.datalist,u(t.list)),e.allcount=t.allcount,e.datalist.length<e.allcount&&t.list.length>0&&(e.searchparameter.isMore=!0))},function(e){})},e.more=function(){e.searchparameter.pageIndex++,e.search()},e.allcount=0,e.getCourseInfo(),e.search()}]),app.controller("allCourseController",["$scope","$stateParams","$rootScope","$interval","$timeout","getDataSource","FilesService","CommonService",function(e,t,a,n,o,i,r,s){function c(e,t){i.getDataSource("mystudy-allcourse-category",{fid:e},function(e){t&&t(e)},function(e){})}function l(e){for(var t=0;t<e.length;t++)u(e[t]);return e}function u(e){return e.photo=r.showFile("coursewarePhoto",e.imagephoto,e.imagephoto),1==e.isplaycompletion?(e.buttontext="已学",e.style=!1):1==e.iselectivechoose&&e.isrequiredchoose?(e.buttontext="已选",e.style=!1):1==e.iselectivechoose?(e.buttontext="选修已选",e.style=!1):1==e.isrequiredchoose?(e.buttontext="必修已选",e.style=!1):(e.buttontext="选课",e.style=!0),e}var d=new Date,f=d.getFullYear();if(e.allYears=[{id:"firstyear",showtext:f+"年",datavalue:" =,"+d.getFullYear()},{id:"twoyear",showtext:f-1+"年",datavalue:" =,"+(f-1)},{id:"thridyear",showtext:f-2+"年",datavalue:" =,"+(f-2)},{id:"fouryear",showtext:f-3+"年",datavalue:" =,"+(f-3)},{id:"fiveyear",showtext:f-4+"年以前",datavalue:" <=,"+(f-4)}],e.allCourseType=[{id:"type_sp",showtext:"视频",datavalue:"0"},{id:"type_fsp",showtext:"非视频",datavalue:"1"}],e.allSearchType=[{id:"search_zx",showtext:"最新",datavalue:"1"},{id:"search_jp",showtext:"精品",datavalue:"2"},{id:"search_tj",showtext:"推荐",datavalue:"3"},{id:"search_ph",showtext:"排行",datavalue:"4"}],e.searchparameter={condation:"",onecate:"",twocate:"",year:"",courseType:"",searchType:"",pageIndex:0,pageSize:6,isMore:!1},t.param){var p=_.find(e.allSearchType,{datavalue:t.param});p&&(e.searchparameter.searchType=t.param,o(function(){$(".pull-right a.pull-searchType.active").removeClass("active"),$("#"+p.id).addClass("active")},1e3))}c("0",function(t){e.oneCategory=t}),e.selectCourse=function(e){var t="indexfront.html#/main/courseinfo/"+e.coursewareid;window.open(t)},e.linkActive=function(t,a){var n="",o=$("#"+a);"pull-one"==t?(n=".pull-right a.pull-one",$(".pull-right a.pull-two:eq(0)").addClass("active"),e.searchparameter.onecate=o.attr("data-value"),e.searchparameter.onecate?(e.searchparameter.twocate="",c(e.searchparameter.onecate,function(t){e.twoCategory=t})):e.twoCategory=[]):"pull-two"==t?(n=".pull-right a.pull-two",e.searchparameter.twocate=o.attr("data-value")):"pull-year"==t?(n=".pull-right a.pull-year",e.searchparameter.year=o.attr("data-value")):"pull-courseType"==t?(n=".pull-right a.pull-courseType",e.searchparameter.courseType=o.attr("data-value")):"pull-searchType"==t&&(n=".pull-right a.pull-searchType",e.searchparameter.searchType=o.attr("data-value")),$(n+".active").removeClass("active"),o.addClass("active"),e.resetSearch()},e.search=function(){e.searchparameter.isMore=!1,i.getUrlData("../api/getcoursewarelist",e.searchparameter,function(t){t.result&&(e.datalist=_.union(e.datalist,l(t.list)),e.allcount=t.allcount,e.datalist.length<e.allcount&&t.list.length>0&&(e.searchparameter.isMore=!0))},function(e){})},e.searchKeyup=function(t){var a=window.event?t.keyCode:t.which;13==a&&e.resetSearch()},e.resetSearch=function(){e.datalist=[],e.searchparameter.pageIndex=1,e.searchparameter.isMore=!1,e.search()},e.more=function(){e.searchparameter.pageIndex++,e.search()},e.allcount=0,e.more()}]),app.controller("menuController",["$scope","$location","$rootScope","$interval","getDataSource","FilesService","CommonService",function(e,t,a,n,o,i,r){}]),app.controller("myclassController",["$scope","$rootScope","$document","$http","getDataSource","FilesService","CommonService","DateService",function(e,t,a,n,o,i,r,s){function c(e){return AnalyticEmotion(e)}function l(e,t,a,n,o){return AnalyticEmotionCallback(e,t,a,n,o)}a[0].title=_.find(t.myStudyLinks,{id:"1005"}).title,$(function(){$("#class_indicatorContainer").radialIndicator({barColor:"#227700",barBgColor:"#FFFFFF",barWidth:3,initValue:100,roundCorner:!0,percentage:!0,displayNumber:!1,radius:77}),$("#my_indicatorContainer").radialIndicator({barColor:"#EE8800",barBgColor:"#FFFFFF",barWidth:6,initValue:100,roundCorner:!0,percentage:!0,displayNumber:!1,radius:54})}),e.myConfig={imgShow:!1,img:{},imgUrl:"",imgList:[],moreShow:!1,imageType:"",interflowBtnShow:!1,showStudentList:{look:!1,select:function(){this.look=!this.look}},coursemoreShow:!1},e.classAndMyStudyRate={class_rate:0,student_rate:0};var u={id:t.user.classId,studentid:t.user.studentId,classid:t.user.classId,classid1:t.user.classId,classid2:t.user.classId,classid3:t.user.classId};o.getDataSource(["getClassInfoById","getClassStudyRateTop4","myclass-studyMaterials","getClassAndMyStudyRate"],u,function(t){e.classInfo=_.find(t,{name:"getClassInfoById"}).data[0],e.studyrateTop4=_.find(t,{name:"getClassStudyRateTop4"}).data;var a=_.find(t,{name:"myclass-studyMaterials"}).data;if(a.length>0)for(var n=["doc","docx","xls","xlsx","ppt","pptx","pdf","jpg","png","gif","bmp","txt"],o=0;o<a.length;o++)_.indexOf(n,a[o].type)<0&&(a[o].type="other");e.studyMaterialsData=a,e.classAndMyStudyRate=_.find(t,{name:"getClassAndMyStudyRate"}).data[0],setTimeout(function(){var t=$("#class_indicatorContainer").data("radialIndicator");t.animate((100*e.classAndMyStudyRate.class_rate).toFixed(0));var a=$("#my_indicatorContainer").data("radialIndicator");a.animate((100*e.classAndMyStudyRate.student_rate).toFixed(0))},300)},function(e){}),e.downFiles=function(e,t,a,n){return i.downApiFiles(n,t,a)},e.myInterval=5e3;var d=e.slideblackboard=[];e.addSlide=function(){o.getDataSource("getClassBloackBoard",{classid:t.user.classId},function(e){e.length<=0&&d.push({id:(new Date).getTime(),src:"../img/myClass_banner.jpg"});for(var t=0;t<e.length;t++){var a=i.showFile("blackboard",e[t].boardimg_servername,e[t].boardimg_servername);d.push({id:e[t].id,src:a})}},function(e){})},e.addSlide(),$("#aCountenance").SinaEmotion($("#txtContent"));var f=function(t,a,n,o){1==a?_.find(_.find(e.interflowData,{id:o}).commentlist,{id:n}).commentcontent=t:0==a&&(_.find(e.interflowData,{id:n}).content=t)};e.defaultUserPhoto="../img/default_img.png",e.defaultEventPhoto="../img/course_img.jpg",e.getImg=function(e,t,a){return i.showFile(a,e,t)},e.headImg=t.user.photopath?e.getImg(t.user.photopath,t.user.photopath,"userPhoto"):e.defaultUserPhoto,e.files=[],e.selectFiles=function(t,a){e.files.length>6||e.files.length+t.length>6?r.alert("最多只能上传6张图片"):e.files=_.union(e.files,t),a&&a.length>0&&r.alert("您选择的"+a.length.toString()+"张图片可能超过了大小限制,无法上传,单张图片最大为2MB",3e3)},e.deleFile=function(t){_.remove(e.files,function(e){return e.$$hashKey==t.$$hashKey})},e.getDateDiff=function(e){return s.getDateDiff(s.getDateTimeStamp(e))},e.currentPageIndex=1,e.currentPageSize=5,e.interflowData=[],e.loadMore=function(){m("more")};var p=0,m=function(a){o.getDataSource(["myclass-interflow","myclass-interflow-commentList","myclass-interflow-imgList"],{pageindex:(e.currentPageIndex-1)*e.currentPageSize+p,pagesize:e.currentPageSize,pageindex1:(e.currentPageIndex-1)*e.currentPageSize+p,pagesize1:e.currentPageSize,pageindex2:(e.currentPageIndex-1)*e.currentPageSize+p,pagesize2:e.currentPageSize,accountid:t.user.accountId,accountid1:t.user.accountId,accountid2:t.user.accountId,classid:t.user.classId,classid1:t.user.classId,classid2:t.user.classId,classid3:t.user.classId},function(t){for(var n=_.find(t,{name:"myclass-interflow"}).data,o=_.find(t,{name:"myclass-interflow-commentList"}).data,i=_.find(t,{name:"myclass-interflow-imgList"}).data,s=0;s<o.length;s++)o[s].headimg?o[s].headimg=e.getImg(o[s].headimg,o[s].headimg,"userPhoto"):o[s].headimg=e.defaultUserPhoto,o[s].commentcontent=l(o[s].commentcontent,1,o[s].id,o[s].fid,f);for(var s=0;s<n.length;s++)n[s].headimg?n[s].headimg=e.getImg(n[s].headimg,n[s].headimg,"userPhoto"):n[s].headimg=e.defaultUserPhoto,n[s].content=l(n[s].content,0,n[s].id,"",f),_.merge(n[s],{commentlist:o.filter(function(e){return e.fid==n[s].id}),imglist:i.filter(function(e){return e.fid==n[s].id})});n&&n.length>0?(e.interflowData=_.union(e.interflowData,n),e.currentPageIndex++,n.length>=e.currentPageSize?e.myConfig.moreShow=!0:e.myConfig.moreShow=!1):a&&"more"==a&&(e.myConfig.moreShow=!1,r.alert("没有更多数据了"))},function(e){})};m(),e.clickALike=function(a){var n=_.find(e.interflowData,{id:a});n.isclick||(n.isclick=1,o.getUrlData("../api/commonPraise",{eventid:a,accountid:t.user.accountId,passive_classid:t.user.classId,passive_accountid:n.accountid,passive_student:n.studentid,usertype:"1",eventtype:n.usertype,group:"20015001",tag:"操作-班级交流点赞"},function(e){"true"==e&&(n.clickcount++,n.isclick=1)},function(e){}))};var g=function(e){var t=$("#"+e),a=$(t).prev();$(t).SinaEmotion($(a))};e.commentShow=function(t){_.find(e.interflowData,{id:t}).commentshow=!_.find(e.interflowData,{id:t}).commentshow,g(t)},e.comment=function(a){var n=_.find(e.interflowData,{id:a}),i=$("#"+a).prev().val();if(n.commentcontent=i,""==n.commentcontent)return void r.alert("请先输入需要评论的内容");var l=o.getGUID();o.getUrlData("../api/interflowComment",{id:l,classid:t.user.classId,content:e.ReplaceAll(n.commentcontent,"\n","<br/>"),accountid:t.user.accountId,fid:a,studentid:t.user.studentId,passive_classid:t.user.classId,passive_accountid:n.accountid,passive_student:n.studentid,usertype:"1",eventtype:n.usertype},function(a){"true"==a&&(n.commentshow=!n.commentshow,n.commentlist.push({id:l,commentcontent:c(e.ReplaceAll(n.commentcontent,"\n","<br/>")),commentuserid:t.user.accountId,commentuser:t.user.name,headimg:e.headImg,createdtime:s.format(new Date,"yyyy-MM-dd hh:mm:ss.S"),isdelete:1,usertype:"1",studentid:t.user.studentId}),n.commentcontent="")},function(e){})},e.interflowcontent="";var h=function(a){o.getUrlData("../api/InsertInterflow",e.classexchangeData,function(n){if("true"==n){var o=[];if(e.classexchangeData.photolist)for(var i=0;i<e.classexchangeData.photolist.length;i++)if(e.classexchangeData.photolist[i].servername){var l=e.classexchangeData.photolist[i].servername.split("."),u=l[0]+"_small."+l[1];o.push({picture_serverthumbname:u,picturename:e.classexchangeData.photolist[i].filename,pictureservername:e.classexchangeData.photolist[i].servername,uploadTime:s.format(new Date,"yyyy-MM-dd hh:mm:ss.S")})}e.interflowData.unshift({id:a,accountid:t.user.accountId,studentid:t.user.studentId,studentname:t.user.name,headimg:e.headImg,createdtime:s.format(new Date,"yyyy-MM-dd hh:mm:ss.S"),content:c(e.ReplaceAll(e.interflowcontent,"\n","<br/>")),imglist:o,commentlist:[],commentcontent:"",commentshow:0,clickcount:0,isdelete:1,isclick:0,usertype:"1"}),p++,e.interflowcontent="",e.files=[],e.myConfig.interflowBtnShow=!1,r.alert("发布成功")}})};e.ReplaceAll=function(e,t,a){for(;e.indexOf(t)>=0;)e=e.replace(t,a);return e},e.interflow=function(){if(e.interflowcontent=$("#txtContent").val(),""==e.interflowcontent)return void r.alert("请先输入需要发布的内容");e.myConfig.interflowBtnShow=!0;var a=o.getGUID();e.classexchangeData={classexchange:{id:a,classid:t.user.classId,content:e.ReplaceAll(e.interflowcontent,"\n","<br/>"),accountid:t.user.accountId,usertype:"1",studentid:t.user.studentId,fid:""}},e.files?i.upLoadPicture(e.files,{upcategory:"interflowPhoto",width:180,height:180},function(t){e.classexchangeData=_.merge(e.classexchangeData,{photolist:t.data}),h(a)},function(e){r.alert("发布失败")}):h(a)},e.deleteInterflow=function(t){confirm("确定要删除吗？")&&o.getDataSource(["delete_sy_classexchange","delete_sy_classexchange_picture","delete_sy_classexchange_praise"],{id:t,fid:t,exchangeid:t,eventid:t},function(a){_.remove(e.interflowData,{id:t}),p--,r.alert("删除成功")},function(e){r.alert("删除失败，请重试")})},e.deleteComent=function(t,a){confirm("确定要删除吗？")&&o.getDataSource(["delete_sy_classexchange_coment"],{id:t},function(n){var o=_.find(e.interflowData,{id:a}).commentlist;_.remove(o,{id:t}),r.alert("删除成功")},function(e){r.alert("删除失败，请重试")})},e.showImg=function(t,a,n){if(e.myConfig.imgShow)e.myConfig.imgShow=!e.myConfig.imgShow,e.myConfig.img={},e.myConfig.imgUrl="",e.myConfig.imgList=[];else{if(e.myConfig.imageType=n,void 0==t||0==t.length)return;e.myConfig.imgUrl=e.getImg(a.pictureservername,a.pictureservername,n),e.myConfig.img=a,e.myConfig.imgList=t,e.myConfig.imgShow=!e.myConfig.imgShow,$(function(){e.ImgHeight={"line-height":$(window).height()+"px"}})}},e.nextImg=function(t){if(e.myConfig.imgList.length>0){var a=_.findIndex(e.myConfig.imgList,function(t){return t==e.myConfig.img}),n=e.myConfig.imgList.length;if(2==t)if(n>a+1){var o=e.myConfig.imgList[a+1];e.myConfig.img=o,e.myConfig.imgUrl=e.getImg(o.pictureservername,o.pictureservername,e.myConfig.imageType)}else r.alert("已经是最后一张");else if(a-1>=0){var o=e.myConfig.imgList[a-1];e.myConfig.img=o,e.myConfig.imgUrl=e.getImg(o.pictureservername,o.pictureservername,e.myConfig.imageType)}else r.alert("已经是第一张")}},e.maxSize=10,e.totalItems=0,e.pageSize=6,e.currentPage=1,e.searchText="",e.ordertype=1,e.pageChanged=function(){var a={classid:t.user.classId,studentid:t.user.studentId,currentPage:e.currentPage,pageSize:e.pageSize,orderType:e.ordertype};o.getUrlData("../api/searchClassCoursewarelist",a,function(t){1==e.currentPage&&(e.totalItems=t.datacount),t&&t.courseList&&t.courseList.length>0&&(e.myConfig.coursemoreShow=!0);for(var a=t.courseList,n=0;n<a.length;n++)a[n].imagephoto=i.showFile("coursewarePhoto",a[n].imagephoto,a[n].imagephoto);e.courseList=a},function(){})},e.pageChanged(),e.selectOrderType=function(t){e.ordertype=t,e.currentPage=1,e.pageChanged()};var y=function(t,a){e.windowObj&&e.windowObj.close(),e.windowObj=window.open("about:blank",a),e.windowObj&&(e.windowObj.location=t)};e.ContinueStudy=function(e){var t="../html/indexvideo.html#/beforevideo/"+e;y(t,"playVideo")}}]),app.controller("myclasslistController",["$scope","$location","$rootScope","$interval","getDataSource","FilesService","CommonService",function(e,t,a,n,o,i,r){e.config={pageIndex:1,pageSize:3,moreShow:!1,pageIndex_history:1,pageSize_history:3,moreShow:[!1,!1],type:0},e.classStatistics={classcount:0,historyclasscount:0},o.getDataSource("getMyClassCount",{studentid:a.user.studentId},function(t){if(t&&t.length>0){var a=_.find(t,{type:0});a&&(e.classStatistics.classcount=a.classcount);var n=_.find(t,{type:1});n&&(e.classStatistics.historyclasscount=n.classcount)}},function(e){}),e.myClasslist=[[],[]];var s=function(t){o.getDataSource("getMyClassList",{pageindex:(e.config.pageIndex-1)*e.config.pageSize,pagesize:e.config.pageSize,userid:a.user.studentId},function(a){a&&a.length>0?(e.myClasslist[0]=_.union(e.myClasslist[0],a),e.config.pageIndex++,a.length>=e.config.pageSize?e.config.moreShow[0]=!0:e.config.moreShow[0]=!1):t&&"more"==t&&(e.config.moreShow[0]=!1,r.alert("没有更多数据了"))},function(e){})};s();var c=function(t){o.getDataSource("getMyHistoryClassList",{pageindex:(e.config.pageIndex_history-1)*e.config.pageSize_history,pagesize:e.config.pageSize_history,userid:a.user.studentId},function(a){a&&a.length>0?(e.myClasslist[1]=_.union(e.myClasslist[1],a),e.config.pageIndex_history++,a.length>=e.config.pageSize_history?e.config.moreShow[1]=!0:e.config.moreShow[1]=!1):t&&"more"==t&&(e.config.moreShow[1]=!1,r.alert("没有更多数据了"))},function(e){})};c(),e.more=function(){0==e.config.type?s("more"):1==e.config.type&&c("more")},e.selecttype=function(t){e.config.type=t,0==t?1==e.config.pageIndex&&s():1==t&&1==e.config.pageIndex_history&&c()},e.goClass=function(e){a.user&&1==a.user.isLogin?(a.user.classId=e,o.getUrlData("../api/ChangeClass",{classid:e},function(e){(e.result=!0)&&(location.href="../html/indexfront.html#/main/myclass")},function(e){})):alert("登录时效已过期,请重新登录")}}]),app.controller("myoptioncourseController",["$scope","$location","$rootScope","$interval","getDataSource","FilesService","CommonService",function(e,t,a,n,o,i,r){}]),app.controller("myrequirecourseController",["$scope","$location","$rootScope","$interval","getDataSource","FilesService","CommonService",function(e,t,a,n,o,i,r){}]),app.controller("mystudyController",["$rootScope","$scope","$http","$location","getDataSource","DateService","GetFileService","CommonService","$stateParams","$sce",function(e,t,a,n,o,i,r,s,c,l){}]),app.controller("studyCenterController",["$scope","$stateParams","$rootScope","$interval","$timeout","getDataSource","FilesService","CommonService",function(e,t,a,n,o,i,r,s){function c(e){for(var t=0;t<e.length;t++)e[t].photo=r.showFile("coursewarePhoto",e[t].imagephoto,e[t].imagephoto);return e}e.searchparameter={condation:"",searchType:"1",pageIndex:0,pageSize:6,isMore:!1},e.linkActive=function(t){$(".right_btnGroup a.active").removeClass("active"),$("#"+t).addClass("active"),e.searchparameter.searchType=t.replace("order",""),e.resetSearch()},e.playVideo=function(e){var t="../html/indexvideo.html#/beforevideo/"+e.coursewareid;window.open(t,"playVideo")},e.remove=function(t){var n=function(){var n={studentid:a.user.studentId,coursewareid:t.coursewareid,status:"-1"};i.getUrlData("../api/addcoursewareuser",n,function(a){a.result?(s.alert("删除记录成功"),_.remove(e.datalist,{wareusrid:t.wareusrid})):s.alert("删除记录失败")},function(e){})};_.merge(a.confirmOptions,{message:"确定要删除该学习记录吗?",confirm:function(){n()}}),a.confirmOptions.open()},e.search=function(){e.searchparameter.isMore=!1,i.getUrlData("../api/getallstudylist",e.searchparameter,function(t){t.result&&(e.datalist=_.union(e.datalist,c(t.list)),e.allcount=t.allcount,e.datalist.length<e.allcount&&t.list.length>0&&(e.searchparameter.isMore=!0))},function(e){})},e.searchKeyup=function(t){var a=window.event?t.keyCode:t.which;13==a&&e.resetSearch()},e.resetSearch=function(){e.datalist=[],e.searchparameter.pageIndex=1,e.searchparameter.isMore=!1,e.search()},e.reset=function(){e.searchparameter.condation="",e.resetSearch()},e.more=function(){e.searchparameter.pageIndex++,e.search()},e.allcount=0,e.more()}]),app.controller("studytotalController",["$scope","$rootScope","$timeout","$state","$stateParams","getDataSource","CommonService",function(e,t,a,n,o,i,r){e.tabs=[{id:"1000",title:"总体情况统计",selected:!1,isshow:!0,index:0,init:function(){e.goAutoCompute()}},{id:"1001",title:"选修学时",selected:!1,isshow:!0,index:1,init:function(){e.inittrain()}},{id:"1002",title:"学习班",selected:!1,isshow:!0,index:2,init:function(){e.inittrain()}},{id:"1003",title:"面授培训",selected:!1,isshow:!0,index:3,init:function(){e.inittrain()}}],e.changetab=function(t,a,n){for(var o=0;o<e.tabs.length;o++)e.tabs[o].selected=!1;t.selected=!0,e.pIndex=t.index,e.pagefilter.type=t.index,e.pagefilter.reset(),e.searchfilter.year=c,e.searchfilter.ctype=0,a&&(e.searchfilter.year=a),n&&(e.searchfilter.ctype=n),t.init&&t.init()},e.selectchanged=function(t){e.pagefilter.reset(),e.pIndex=t;var a=e.tabs[e.pIndex];a.init&&a.init()};var s=new Date,c=s.getFullYear();e.yearArr=[];for(var l=2012,u=l;c>=u;u++)e.yearArr.push(u);e.searchfilter={year:c,totalscore:0,classid:""},a(function(){
e.searchfilter.year=c,e.pageinit()},500),e.pIndex=0,e.pagefilter={maxSize:6,totalItems:0,pageSize:10,currentPage:1,type:0,reset:function(){this.maxSize=6,this.totalItems=0,this.pageSize=10,this.currentPage=1,e.datalist=[],e.ClassAttr.isclassattr=!1,e.searchfilter.totalscore=0,e.total.isshow=!1}},e.pageChanged=function(){var t=e.tabs[e.pIndex];t.init&&t.init()},e.gotrain=function(){n.go("main.train1")},e.inittrain=function(){var t=_.merge({},e.searchfilter,e.pagefilter);i.getUrlData("../api/gettrain",t,function(t){t.result&&(e.datalist=t.items,e.pagefilter.totalItems=t.rows.totalItems,e.searchfilter.totalscore=t.rows.totalscore)},function(e){})},e.submittrain=function(a,n){var o=0==n?"确定要取消提交该面授培训吗?":"确定要提交该面授培训吗",s=function(){var t={status:n,id:a.id,remark:""};i.getDataSource("submitrain",t,function(t){t[0]&&t[0].crow>0&&(r.alert("操作成功"),e.tabs[e.pIndex].init())},function(e){})};_.merge(t.confirmOptions,{message:o,confirm:function(){s()}}),t.confirmOptions.open()},e.deletetrain=function(a){var n=function(){var t={id:a.id};i.getDataSource("deletetrain",t,function(t){t[0]&&t[0].crow>0&&(r.alert("操作成功"),e.tabs[e.pIndex].init())},function(e){})};_.merge(t.confirmOptions,{message:"确定要删除该面授培训吗",confirm:function(){n()}}),t.confirmOptions.open()},e.edittrain=function(e){n.go("main.train2",{id:e.id})},e.ClassAttr={isclassattr:!1,classname:""},e.goClassAttr=function(t){e.ClassAttr.isclassattr=!0,e.ClassAttr.classname=t.classname,e.searchfilter.classid=t.classid,e.pagefilter.type=4,e.inittrain()},e.total={totalstutytime:0,totaltime:0,totaltimecn:"",isshow:!1},e.getArchives=function(){var a={};a.studentid=t.user.studentId,a.startyear=e.searchfilter.year,a.endyear=e.searchfilter.year-4,i.getDataSource("getarchives",a,function(t){if(t&&t.length>0){for(var a=0;a<t.length;a++)t[a].expand=!1,t[a].src="../img/arrow01.png",t[a].keywordsArr=t[a].keywords.split(","),t[a].total_time_cn=(parseInt(t[a].total_time)/3600).toFixed(1),e.total.totalstutytime+=t[a].total_studytime,e.total.totaltime+=parseInt(t[a].total_time);e.total.isshow=!0,e.total.totaltimecn=(parseInt(e.total.totaltime)/3600).toFixed(1),t[0].expand=!0,t[0].src="../img/arrow02.png",e.datalist=t}},function(e){})},e.onExpand=function(e){e.expand=!e.expand,e.src=0==e.expand?"../img/arrow01.png":"../img/arrow02.png"},e.goChange=function(t,a,n){var o=e.tabs[parseInt(t)];o.isshow&&e.changetab(o,a,n)},e.goCompute=function(){_.merge(t.confirmOptions,{message:"确定要重新生成学习档案吗，这将花费您一定的时间?",confirm:function(){e.goAutoCompute()}}),t.confirmOptions.open()},e.goAutoCompute=function(){t.loadingOptions.message="正在重新生成学习档案,请稍候....",t.loadingOptions.isOpened=!0;var a={};a.departmentid=t.user.departmentId,a.studentid=t.user.studentId,a.accountid=t.user.accountId,a.rank=t.user.yearplan.rank,i.getUrlData("../api/gettotal",a,function(a){t.loadingOptions.isOpened=!1,a.result&&e.getArchives()},function(e){})},e.pageinit=function(){var t=o.no;if(t&&parseInt(t)<e.tabs.length){var a=e.tabs[parseInt(t)];a.isshow&&e.changetab(a,0)}}}]),app.controller("trainController",["$scope","$rootScope","$state","$timeout","$stateParams","getDataSource","DateService","CommonService",function(e,t,a,n,o,i,r,s){e.train={title:"",categoryone:"组织调训",categorytwo:"业务培训",categorythree:"面授培训",categoryfour:"境内培训",starttime:"",endtime:"",studytime:"",year:"",address:"",company:"",reference:"",status:0,remark:""},e.buttonCtrl={btnSaveStatu:!1,btnSubmitStatus:!1,btnSaveDisplay:!0,btnSubmitDisplay:!0,enableEdited:!1};var c=new Date,l=c.getFullYear();e.yearArr=[];for(var u=2012;l+2>u;u++)e.yearArr.push(u);e.pageinit=function(){e.train.year=l,o.id&&(e.buttonCtrl.btnSaveDisplay=!1,e.buttonCtrl.btnSubmitDisplay=!1,i.getDataSource("gettrain",{id:o.id},function(t){t[0]&&(e.train=t[0],e.train.starttime=r.format(t[0].starttime,"yyyy-MM-dd"),e.train.endtime=r.format(t[0].endtime,"yyyy-MM-dd")),0==e.train.status?(e.buttonCtrl.btnSaveDisplay=!0,e.buttonCtrl.btnSubmitDisplay=!0):1==e.train.status&&(e.buttonCtrl.btnSaveDisplay=!1,e.buttonCtrl.btnSubmitDisplay=!1),0!=e.train.status&&(e.buttonCtrl.enableEdited=!0)},function(e){}))},e.submit=function(t){return new Date(e.train.starttime)>new Date(e.train.endtime)?void s.alert("面授的开始时间不能大于结束时间"):(e.buttonCtrl.btnSubmitStatus=!0,e.buttonCtrl.btnSaveStatu=!0,e.train.status=t,void i.getUrlData("../api/addtrain",e.train,function(a){s.alert(a.message),a.result?(e.train.id=a.trainid,0==t?(e.buttonCtrl.btnSubmitStatus=!1,e.buttonCtrl.btnSaveStatu=!1):1==t&&(e.buttonCtrl.btnSaveDisplay=!1,e.buttonCtrl.btnSubmitDisplay=!1)):(e.buttonCtrl.btnSubmitStatus=!1,e.buttonCtrl.btnSaveStatu=!1)},function(e){}))},e.cancel=function(){a.go("main.studytotal",{no:3})},n(function(){e.pageinit()},500)}]);